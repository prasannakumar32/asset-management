extends ../navbar

block content
  .container-fluid.employee-page-container
    .row.employee-page-row
      .col-12
        h1.employee-page-header Employee Directory 
    .row.employee-actions-row
      .col-12
        .asset-actions
          a.btn.btn-primary.shadow(href='/employee/form')
            i.fas.fa-plus.me-2
            | Add New
          a.btn.btn-success.shadow(href='/asset-assignment/issue')
            i.fas.fa-hand-holding-box.me-2
            | Issue Asset
          a.btn.btn-warning.shadow(href='/asset-assignment/return')
            i.fas.fa-undo.me-2
            | Return Asset
          a.btn.btn-danger.shadow(href='/asset-assignment/scrap')
            i.fas.fa-trash.me-2
            | Scrap Asset
          button.btn.btn-info.shadow.ms-2(type='button', onclick='clearAllFilters()')
            i.fas.fa-filter-circle-xmark.me-2
            | Clear Filters
    
    script.
      // Wait for DOM to be fully loaded
      document.addEventListener('DOMContentLoaded', function() {
        loadFilterOptions();
        loadEmployees();
        
        // Auto submit for filters using api
        const departmentSelect = document.getElementById('department');
        const statusSelect = document.getElementById('status');
        const branchSelect = document.getElementById('branch');
        
        // Helper function 
        function addFilterListener(element, callback) {
          if (element) {
            element.addEventListener('change', callback);
          }
        }

        // Add event listeners for filter controls
        addFilterListener(departmentSelect, loadEmployees);
        addFilterListener(statusSelect, loadEmployees);
        addFilterListener(branchSelect, loadEmployees);
      });
      
      // Load filter options 
      function loadFilterOptions() {
        // Load departments and branches from api
        fetch('/api/employee/employee-form-options')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              populateDepartments(data.data.departments);
              populateBranches(data.data.branches);
            } else {
              console.error('Error loading filter options:', data.error);
            }
          })
          .catch(error => {
            console.error('Error loading filter options:', error);
          });
      }
      
      // Populate department dropdown
      function populateDepartments(departments) {
        const departmentSelect = document.getElementById('department');
        if (!departmentSelect) return;
        
        // Clear existing options except "All"
        departmentSelect.innerHTML = '<option value="">All</option>';
        
        departments.forEach(department => {
          const option = document.createElement('option');
          option.value = department;
          option.textContent = department;
          departmentSelect.appendChild(option);
        });
      }
      
      // Populate branch dropdown
      function populateBranches(branches) {
        const branchSelect = document.getElementById('branch');
        if (!branchSelect) return;
        
        // Clear existing options except "All"
        branchSelect.innerHTML = '<option value="">All</option>';
        
        branches.forEach(branch => {
          const option = document.createElement('option');
          option.value = branch;
          option.textContent = branch;
          branchSelect.appendChild(option);
        });
      }
      
      // Load employees
      function loadEmployees() {
        const department = document.getElementById('department')?.value || '';
        const status = document.getElementById('status')?.value || '';
        const branch = document.getElementById('branch')?.value || '';
        
        const params = new URLSearchParams({ department, status, branch });
        
        fetch('/api/employee?' + params.toString())
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              updateEmployeeTable(data.data.employees);
            } else {
              console.error('Error loading employees:', data.error);
            }
          })
          .catch(error => {
            console.error('Error loading employees:', error);
          });
      }
      
      // Update employee table 
      function updateEmployeeTable(employees) {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (employees.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="7" class="text-center py-4 text-muted">
              <i class="fas fa-search me-2"></i>
              No employees found for the selected filters
            </td>
          `;
          tbody.appendChild(row);
          return;
        }
        
        employees.forEach(emp => {
          const row = document.createElement('tr');
          row.innerHTML = 
            '<td class="name-td">' +
              '<span>' + emp.first_name + ' ' + emp.last_name + '</span>' +
            '</td>' +
            '<td class="position-td">' +
              '<span>' + (emp.position || '') + '</span>' +
            '</td>' +
            '<td class="department-td">' +
              '<span>' + (emp.department || '') + '</span>' +
            '</td>' +
            '<td class="status-td">' +
              '<span>' + (emp.status === 'active' ? 'Active' : 'Inactive') + '</span>' +
            '</td>' +
            '<td class="phone-td">' +
              '<span>' + (emp.phone || '') + '</span>' +
            '</td>' +
            '<td class="email-td">' +
              '<span>' + (emp.email || '') + '</span>' +
            '</td>' +
            '<td class="actions-td">' +
              '<div class="d-flex gap-1 justify-content-end">' +
                '<a href="/employee/' + emp.id + '/form" class="btn btn-outline-primary btn-sm action-btn" title="Edit Employee">' +
                  '<i class="fas fa-edit"></i>' +
                '</a>' +
                '<a href="/employee/' + emp.id + '/view" class="btn btn-outline-info btn-sm action-btn" title="View Employee Details">' +
                  '<i class="fas fa-eye"></i>' +
                '</a>' +
                '<button class="delete-btn" type="button" onclick="confirmDelete(' + emp.id + ', \'' + emp.first_name + ' ' + emp.last_name + '\')" title="Delete Employee">' +
                  '<i class="fas fa-trash"></i>' +
                '</button>' +
              '</div>' +
            '</td>';
          tbody.appendChild(row);
        });
      }
      
      // Clear all filters function
      function clearAllFilters() {
        const dept = document.getElementById('department');
        const status = document.getElementById('status');
        const branch = document.getElementById('branch');
        if (dept) dept.value = '';
        if (status) status.value = 'active';
        if (branch) branch.value = '';
        loadEmployees();
      }
      
      // Delete confirmation 
      function confirmDelete(employeeId, employeeName) {
        if (confirm('Are you sure you want to delete ' + employeeName + '? This action cannot be undone.')) {
          fetch('/api/employee/' + employeeId, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success || data.redirect) {
              loadEmployees(); // Reload the employees table
            } else {
              console.error('Error deleting employee:', data.error);
            }
          })
          .catch(error => {
            console.error('Error deleting employee:', error);
          });
        }
      }
    .row.employee-list-row
      .col-12
        .card
          .card-header.mb-3
            .d-flex.justify-content-between.align-items-center
              h5.mb-0.card-title
                i.fas.fa-list.me-2
                | Employee List
              .ms-auto
              form.d-flex.align-items-end.justify-content-end.gap-3(method='GET', action='/employee')#filterForm
                  .filter-form-group
                    label.form-label.mb-0.fs-sm.text-muted(for='department') Department
                    select.form-select.form-select-sm(name='department', id='department')
                      option(value='') All
                      if departments && departments.length > 0
                        each dept in departments
                            option(value=dept, selected=department === dept)= dept
                  .filter-form-group
                    label.form-label.mb-0.fs-sm.text-muted(for='status') Status
                    select.form-select.form-select-sm(name='status', id='status')
                      option(value='active', selected=status === 'active') Active
                      option(value='inactive', selected=status === 'inactive') Inactive
                  .filter-form-group
                    label.form-label.mb-0.fs-sm.text-muted(for='branch') Branch
                    select.form-select.form-select-sm(name='branch', id='branch')
                      option(value='') All
                      if branches && branches.length > 0
                        each b in branches
                          option(value=b, selected=branch === b)= b
            .card-body.pt-3
                .table-responsive
                  table.table.table-hover.mb-0.table.mt-3
                    thead
                      tr
                        th.name-col Name
                        th.position-col Position
                        th.department-col Department
                        th.status-col Status
                        th.phone-col Phone 
                        th.email-col Email
                        th.actions-col Actions
                    tbody
                    