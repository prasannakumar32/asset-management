extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;" id="formTitle")
          i.fas.fa-user-plus.me-2(style="color: #4e73df;")
          | Add New Employee
        
        // Flash messages container
        #alertContainer
        
        form(action='/api/employee', method='POST', id='employeeForm', novalidate)
          .form-section
            h6.form-section-title
              i.fas.fa-user.me-2
              | Personal Information
            .form-row
              .form-group-wrapper
                label(for='first_name')
                  span.required-field First Name
                input(type='text' class='form-control' id='first_name' name='first_name' 
                      required
                      minlength='2'
                      pattern='[a-zA-Z\s]+'
                      title='First name should only contain letters and spaces, minimum 2 characters'
                      placeholder='Enter first name'
                      oninput='this.value = this.value.trim();')
                .invalid-feedback(id='first_name-error')
              .form-group-wrapper
                label(for='last_name')
                  span.required-field Last Name
                input(type='text' class='form-control' id='last_name' name='last_name' 
                      pattern='[a-zA-Z\s]+'
                      placeholder='Enter last name'
                      oninput='this.value = this.value.trim();')
                .invalid-feedback(id='last_name-error')
            .form-row
              .form-group-wrapper
                label(for='email')
                  span.required-field Email
                input(type='email' class='form-control' id='email' name='email' 
                      required
                      maxlength='100'
                      placeholder='Enter email address'
                      oninput='this.value = this.value.trim();')
                .invalid-feedback(id='email-error')
              .form-group-wrapper
                label.form-label
                  i.fas.fa-phone.me-1
                  | Phone
                input.form-control(type='tel', name='phone', id='phone',
                      placeholder='Enter phone number with country code (e.g., +919003381176) or 10 digits',
                      pattern='^(?:\\+\\d{1,3}\\s?)?\\d{10}$',
                      maxlength='14',
                      title='Enter 10 digits or country code + 10 digits (e.g., 9003381176 or +919003381176)')
                .invalid-feedback(id='phone-error')
            .form-row
              .form-group-wrapper
                label(for='employee_id') Employee ID
                input(type='text' class='form-control' id='employee_id' name='employee_id' 
                      maxlength='20'
                      pattern='[a-zA-Z0-9\s]+'
                      title="Employee ID should only contain letters, numbers, and spaces"
                      placeholder='Will be auto-generated'
                      oninput='this.value = this.value.trim();')
                .invalid-feedback(id='employee_id-error')
          .form-section
            h6.form-section-title
              i.fas.fa-briefcase.me-2
              | Job Information
            .form-row
              .form-group-wrapper
                label(for='position') Position
                input(type='text' class='form-control' id='position' name='position' 
                      placeholder='Enter job position'
                      oninput='this.value = this.value.trim();'
                      pattern='[a-zA-Z\s]+'
                      title='Position should only contain letters and spaces')
                .invalid-feedback(id='position-error')
              .form-group-wrapper
                label(for='department')
                  span.required-field Department
                select.form-control(id='department' name='department' required)
                  option(value='') Select Department
                .invalid-feedback(id='department-error')
            .form-row
              .form-group-wrapper
                label(for='branch')
                  span.required-field Branch
                select.form-control(id='branch' name='branch' required)
                  option(value='') Select Branch
                .invalid-feedback(id='branch-error')
              .form-group-wrapper
                label(for='hire_date') 
                  span.required-field Hire Date
                input(type='date' class='form-control' id='hire_date' name='hire_date' 
                      required
                      placeholder='please select hire date')
                .invalid-feedback(id='hire_date-error')
            .form-row
              .form-group-wrapper
                label(for='status')
                  span.required-field Status
                select(class='form-control' id='status' name='status' required)
                  option(value='') Select Status
                  option(value='active') Active
                  option(value='inactive') Inactive
                .invalid-feedback(id='status-error')
          .form-section
            h6.form-section-title
              i.fas.fa-sticky-note.me-2
              | Additional Information
            .form-row
              .form-group-wrapper.full-width
                label(for='notes') Notes
                textarea(class='form-control' id='notes' name='notes' rows='4' 
                      placeholder='Enter any additional notes or comments')
          .form-dialog-footer
            a.form-action-btn.form-action-btn-secondary(href='/employee')
              i.fas.fa-times
              | Cancel
            a.form-action-btn.form-action-btn-secondary(id='viewEmployeeBtn' style='display: none;')
              i.fas.fa-eye
              | View
            button.form-action-btn.form-action-btn-primary(type='submit')
              i.fas.fa-save
              | Add Employee

    script.
      // Global variables
      let isEdit = false;
      let employeeId = null;
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        // Check if we're in edit mode by checking the URL
        const pathParts = window.location.pathname.split('/');
        isEdit = pathParts.includes('form') && pathParts.length > 3 && pathParts[pathParts.length - 2] !== 'form';
        
        // Load form option
        loadFormOptions().then(() => {
          if (isEdit) {
            employeeId = pathParts[pathParts.length - 2];
            loadEmployeeData(employeeId);
            updateFormForEdit();
          }
        });
        
        // Setup form submission
        setupFormSubmission();
      });
      
      // Update form for edit mode
      function updateFormForEdit() {
        document.getElementById('formTitle').innerHTML = `
          <i class="fas fa-edit me-2" style="color: #4e73df;"></i>
          Edit Employee
        `;
        document.querySelector('button[type="submit"]').innerHTML = `
          <i class="fas fa-save"></i>
          Update Employee
        `;
        document.getElementById('employee_id').readOnly = true;
        document.getElementById('viewEmployeeBtn').style.display = 'inline-flex';
      }
      
      // Load form options (departments and branches)
      async function loadFormOptions() {
        try {
          const response = await fetch('/api/employee/employee-form-options');
          const result = await response.json();
          
          if (result.success) {
            // Load departments
            const departmentSelect = document.getElementById('department');
            if (departmentSelect) {
              departmentSelect.innerHTML = '<option value="">Select Department</option>';
              result.data.departments.forEach(department => {
                const option = document.createElement('option');
                option.value = department;
                option.textContent = department;
                departmentSelect.appendChild(option);
              });
            }

            // Load branches
            const branchSelect = document.getElementById('branch');
            if (branchSelect) {
              branchSelect.innerHTML = '<option value="">Select Branch</option>';
              result.data.branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                branchSelect.appendChild(option);
              });
            }
          }
        } catch (error) {
          console.error('Error loading form options:', error);
          showAlert('Error loading form options', 'danger');
        }
      }
      
      // Load employee data for edit mode
      async function loadEmployeeData(employeeId) {
        try {
          const response = await fetch(`/api/employee/${employeeId}`);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
            const employee = result.data.employee;
            
            // Helper function to safely set element value
            const safeSetValue = (elementId, value) => {
              const element = document.getElementById(elementId);
              if (element) {
                element.value = value || '';
              } else {
                console.error(`Element not found: ${elementId}`);
              }
            };
            
            // Populate form fields safely
            safeSetValue('first_name', employee.first_name);
            safeSetValue('last_name', employee.last_name);
            safeSetValue('email', employee.email);
            safeSetValue('phone', employee.phone);
            safeSetValue('employee_id', employee.employee_id);
            safeSetValue('position', employee.position);
            safeSetValue('department', employee.department);
            safeSetValue('branch', employee.branch);
            safeSetValue('hire_date', employee.hire_date ? new Date(employee.hire_date).toISOString().split('T')[0] : '');
            safeSetValue('status', employee.status);
            safeSetValue('notes', employee.notes);
            
            // Update form action for edit mode
            const form = document.getElementById('employeeForm');
            if (form) {
              form.action = `/api/employee/${employeeId}?_method=PUT`;
            }
            
            // Set View button href
            const viewBtn = document.getElementById('viewEmployeeBtn');
            if (viewBtn) {
              viewBtn.href = `/employee/${employeeId}`;
            }
          } else {
            throw new Error(result.error || 'Failed to load employee data');
          }
        } catch (error) {
          showAlert(`Error loading employee data: ${error.message}`, 'danger');
        }
      }
      
      // Setup form submission
      function setupFormSubmission() {
        const form = document.getElementById('employeeForm');
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Clear previous errors
          clearErrors();
          
          // Simple frontend validation for required fields
          const requiredFields = ['first_name', 'email', 'department', 'branch', 'status', 'hire_date'];
          const validationErrors = {};
          
          requiredFields.forEach(field => {
            const element = document.getElementById(field);
            const value = element ? element.value.trim() : '';
            
            if (!value) {
              const fieldName = field.replace('_', ' ');
              validationErrors[field] = `${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} is required`;
            }
          });
          
          // Email validation
          const emailElement = document.getElementById('email');
          if (emailElement && emailElement.value.trim()) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(emailElement.value.trim())) {
              validationErrors.email = 'Please enter a valid email address';
            }
          }
          
          // If there are validation errors, show them and stop submission
          if (Object.keys(validationErrors).length > 0) {
            Object.keys(validationErrors).forEach(field => {
              showFieldError(field, validationErrors[field]);
            });
            showAlert('Please fix the errors below', 'danger');
            return;
          }
          
          // Get form data
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          
          try {
            const url = isEdit ? `/api/employee/${employeeId}` : '/api/employee';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
              showAlert(result.message || 'Employee saved successfully', 'success');
              setTimeout(() => {
                window.location.href = '/employee';
              }, 1500);
            } else {
              // Show error message
              showAlert(result.error || 'Error saving employee', 'danger');
              
              // Show field-specific errors if available
              if (result.fieldErrors) {
                Object.keys(result.fieldErrors).forEach(field => {
                  showFieldError(field, result.fieldErrors[field]);
                });
              }
            }
          } catch (error) {
            console.error('Error submitting form:', error);
            showAlert('Error submitting form', 'danger');
          }
        });
      }
      
      // Show alert message
      function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-3`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
      }
      
      // Show field-specific error
      function showFieldError(field, message) {
        const errorElement = document.getElementById(`${field}-error`);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.style.display = 'block';
        }
      }
      
      // Clear all errors
      function clearErrors() {
        document.querySelectorAll('.invalid-feedback').forEach(element => {
          element.textContent = '';
          element.style.display = 'none';
        });
      }