extends ../navbar

block content
  .container-fluid.px-4.py-4.asset-page-container
    .row.mb-4.asset-page-row
      .col-12
        h1.text-center.mb-4.asset-page-header Asset Inventory
    .row.mb-4.asset-actions-row
      .col-12
        .asset-actions
          a.btn.btn-primary.shadow(href='/assets/form')
            i.fas.fa-plus.me-2
            | Add New
          a.btn.btn-success.shadow(href='/asset-assignment/issue')
            i.fas.fa-hand-holding-box.me-2
            | Issue Asset
          a.btn.btn-warning.shadow(href='/asset-assignment/return')
            i.fas.fa-undo.me-2
            | Return Asset
          a.btn.btn-danger.shadow(href='/asset-assignment/scrap')
            i.fas.fa-trash.me-2
            | Scrap Asset
          button.btn.btn-info.shadow.ms-2(type='button', onclick='clearAllFilters()')
            i.fas.fa-filter-circle-xmark.me-2
            | Clear Filters
    
    script.
      document.addEventListener('DOMContentLoaded', function() {
        loadFilterOptions();
        loadAssets();
        
        // Auto submit for filters 
        const categorySelect = document.getElementById('category');
        const statusSelect = document.getElementById('status');
        const isActiveSelect = document.getElementById('is_active');
        const branchSelect = document.getElementById('branch');
        
        // Helper function
        function addFilterListener(element, callback) {
          if (element) {
            element.addEventListener('change', callback);
          }
        }

        // Add event listeners for filter controls
        addFilterListener(categorySelect, loadAssets);
        addFilterListener(statusSelect, loadAssets);
        addFilterListener(isActiveSelect, loadAssets);
        addFilterListener(branchSelect, loadAssets);
      });
      
      // Load filter options (categories and branches)
      function loadFilterOptions() {
        // Load categories
        fetch('/api/asset-categories')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              populateCategories(data.data.categories);
            } else {
              console.error('Error loading categories:', data.error);
            }
          })
          .catch(error => {
            console.error('Error loading categories:', error);
          });
        
        // Load branches from assets
        fetch('/api/assets')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              populateBranches(data.data.assets);
            } else {
              console.error('Error loading branches:', data.error);
            }
          })
          .catch(error => {
            console.error('Error loading branches:', error);
          });
      }
      
      // Populate category dropdown
      function populateCategories(categories) {
        const categorySelect = document.getElementById('category');
        if (!categorySelect) return;
        
        // Clear existing options except "All"
        categorySelect.innerHTML = '<option value="">All</option>';
        
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          categorySelect.appendChild(option);
        });
      }
      
      // Populate branch dropdown
      function populateBranches(assets) {
        const branchSelect = document.getElementById('branch');
        if (!branchSelect) return;
        
        // Clear existing options except "All"
        branchSelect.innerHTML = '<option value="">All</option>';
        
        // Get unique branches
        const branchSet = new Set();
        assets.forEach(asset => {
            if (asset.branch) {
                branchSet.add(asset.branch);
            }
        });
        const branches = Array.from(branchSet).sort();
        
        branches.forEach(branch => {
          const option = document.createElement('option');
          option.value = branch;
          option.textContent = branch;
          branchSelect.appendChild(option);
        });
      }
      
      // Load assets
      function loadAssets() {
        const category = document.getElementById('category')?.value || '';
        const status = document.getElementById('status')?.value || '';
        const is_active = document.getElementById('is_active')?.value || '';
        const branch = document.getElementById('branch')?.value || '';
        
        const params = new URLSearchParams({ category, status, is_active, branch });
        
        fetch(`/api/assets?${params}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              updateAssetTable(data.data.assets);
            } else {
              console.error('Error loading assets:', data.error);
            }
          })
          .catch(error => {
            console.error('Error loading assets:', error);
          });
      }
      
      // Update asset table with new data
      function updateAssetTable(assets) {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (assets.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="6" class="text-center py-4 text-muted">
              <i class="fas fa-search me-2"></i>
              No assets found for the selected filters
            </td>
          `;
          tbody.appendChild(row);
          return;
        }
        
        assets.forEach(asset => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="name-td">
              <span>${asset.name}</span>
            </td>
            <td class="category-td">
              ${asset.category ? `<span>${asset.category.name}</span>` : ''}
            </td>
            <td class="serial-td">
              <span>${asset.serial_number}</span>
            </td>
            <td class="status-td">
              ${asset.status}
            </td>
            <td class="location-td">
              <span>${asset.location}</span>
            </td>
            <td class="actions-td">
              <div class="btn-group btn-group-sm" role="group">
                <a href="/assets/${asset.id}/form" class="btn btn-outline-primary action-btn" title="Edit Asset">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="/assets/${asset.id}" class="btn btn-outline-info action-btn" title="View Asset Details">
                  <i class="fas fa-eye"></i>
                </a>
                <button class="delete-btn btn btn-outline-danger" type="button" onclick="confirmDelete(${asset.id}, '${asset.name}')" title="Delete Asset">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
      
      // Clear all filters function
      function clearAllFilters() {
        document.getElementById('category').value = '';
        document.getElementById('status').value = '';
        document.getElementById('is_active').value = '';
        document.getElementById('branch').value = '';
        loadAssets();
      }
      
      // Delete confirmation 
      function confirmDelete(assetId, assetName) {
        if (confirm('Are you sure you want to delete "' + assetName + '"? This action cannot be undone.')) {
          fetch(`/api/assets/${assetId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success || data.redirect) {
              loadAssets(); // Reload the assets table
            } else {
              console.error('Error deleting asset:', data.error);
            }
          })
          .catch(error => {
            console.error('Error deleting asset:', error);
          });
        }
      }
    .row.asset-list-row
      .col-12
        .card
          .card-header.mb-3
            .d-flex.justify-content-between.align-items-center
              h5.mb-0.card-title
                i.fas.fa-list.me-2
                | Asset List
              .ms-auto
                form.d-flex.align-items-end.justify-content-end.gap-3(method='GET', action='/assets')#filterForm
                  .filter-form-group
                    label.form-label.mb-0.fs-sm.text-muted(for='category') Category
                    select.form-select.form-select-sm(name='category', id='category')
                      option(value='') All
                  .filter-form-group
                    label.form-label.mb-0.fs-sm.text-muted(for='status') Status
                    select.form-select.form-select-sm(name='status', id='status')
                      option(value='') All
                      option(value='available') Available
                      option(value='assigned') Assigned
                      option(value='maintenance') Maintenance
                      option(value='retired') Retired
                      option(value='scrapped') Scrapped
                  .filter-form-group
                    label.form-label.mb-0.fs-sm.text-muted(for='is_active') Active
                    select.form-select.form-select-sm(name='is_active', id='is_active')
                      option(value='') All
                      option(value='true') Active
                      option(value='false') Inactive
                  .filter-form-group
                    label.form-label.mb-0.fs-sm.text-muted(for='branch') Branch
                    select.form-select.form-select-sm(name='branch', id='branch')
                      option(value='') All
          .card-body.pt-3
                table.table.table-hover.mb-0.table.mt-3
                  thead
                    tr
                      th.name-col Name
                      th.category-col Category
                      th.serial-col Serial Number
                      th.status-col Status
                      th.assigned-col Location
                      th.actions-col Actions
                  tbody
