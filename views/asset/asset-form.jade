extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;")
          if isEdit
            i.fas.fa-edit.me-2(style="color: #4e73df;")
            | Edit Asset
          else
            i.fas.fa-plus.me-2(style="color: #4e73df;")
            | Add New Asset
        
        // Messages
        if error && error.length > 0
          .alert.alert-danger.mb-3
            = error
        
        if success && success.length > 0
          .alert.alert-success.mb-3
            = success
        
        form(action=(isEdit ? `/assets/${asset.id}?_method=PUT` : '/assets'), method='POST', id='assetForm', novalidate)
          .form-section
            h6.form-section-title
              i.fas.fa-info-circle.me-2
              | Basic Information
            .form-row
              .form-group-wrapper
                label(for='name')
                  span.required-field Asset Name
                input(type='text' class='form-control' id='name' name='name' 
                      value=(isEdit ? (asset && asset.name) || (formData && formData.name) : (formData && formData.name) || '') 
                      required
                      placeholder='Enter asset name')
              .form-group-wrapper
                label(for='asset_tag') Asset Tag
                input(type='text' class='form-control' id='asset_tag' name='asset_tag' 
                      value=(isEdit ? (asset && asset.asset_tag) || (formData && formData.asset_tag) : (formData && formData.asset_tag) || '') 
                      readonly=isEdit
                      placeholder='Auto-generated on creation'
                      class=isEdit ? 'form-control' : ('form-control ' + (error && error.includes('Asset tag') ? 'is-invalid' : '')))
                if error && error.includes('Asset tag')
                  .invalid-feedback
                    i.fas.fa-exclamation-circle.me-1
                    = error
              .form-group-wrapper
                label(for='category_id')
                  span.required-field Category
                select.form-control(id='category_id' name='category_id' required)
                  option(value='') Select Category
                  if categories && categories.length > 0
                    each category in categories
                      option(value=category.id 
                             selected=(isEdit ? (asset && asset.category_id === category.id) || (formData && formData.category_id == category.id) : (formData && formData.category_id == category.id)))
                        = category.name
              .form-group-wrapper
                label(for='serial_number') Serial Number
                input(type='text' class='form-control' id='serial_number' name='serial_number' 
                      value=((isEdit ? (asset && asset.serial_number) : (formData && formData.serial_number)) || '')
                      placeholder='Enter serial number')
              .form-group-wrapper
                label(for='model') Model
                input(type='text' class='form-control' id='model' name='model' 
                      value=(isEdit ? (asset && asset.model) || (formData && formData.model) : (formData && formData.model) || '')
                      placeholder='Enter model')
              .form-group-wrapper
                label(for='manufacturer') Manufacturer
                input(type='text' class='form-control' id='manufacturer' name='manufacturer' 
                      value=(isEdit ? (asset && asset.manufacturer) || (formData && formData.manufacturer) : (formData && formData.manufacturer) || '')
                      placeholder='Enter manufacturer')
          .form-section
            h6.form-section-title
              i.fas.fa-dollar-sign.me-2
              | Financial Information
            .form-row
              .form-group-wrapper
                label(for='purchase_date') Purchase Date
                input(type='text' class='form-control' id='purchase_date' name='purchase_date' 
                      value=(formData && formData.purchase_date ? formData.purchase_date : (isEdit && asset && asset.purchase_date ? new Date(asset.purchase_date).toLocaleDateString('en-GB') : ''))
                      placeholder='DD/MM/YYYY (e.g., 15/01/2024)'
                      title='Enter date in DD/MM/YYYY format'
                      oninput="this.setCustomValidity('')"
                      oninvalid="this.setCustomValidity('Please enter a valid date in DD/MM/YYYY format')")
                small.text-muted Expected format: DD/MM/YYYY
              .form-group-wrapper
                label(for='purchase_cost')
                  i.fas.fa-dollar-sign.me-1
                  | Purchase Cost (₹)
                input(type='text' class='form-control' id='purchase_cost' name='purchase_cost' 
                      pattern='\d*\.?\d*' 
                      value=(isEdit ? (asset && asset.purchase_cost) || (formData && formData.purchase_cost) : (formData && formData.purchase_cost) || '')
                      placeholder='0.00'
                      oninput='this.value = this.value.replace(/[^0-9.]/g, ""); if(this.value < 0) this.value = 0;')
            .form-row
              .form-group-wrapper
                label(for='current_value')
                  i.fas.fa-dollar-sign.me-1
                  | Current Value (₹)
                input(type='text' class='form-control' id='current_value' name='current_value' 
                      pattern='\d*\.?\d*' 
                      value=(isEdit ? (asset && asset.current_value) || (formData && formData.current_value) : (formData && formData.current_value) || '')
                      placeholder='0.00'
                      oninput='this.value = this.value.replace(/[^0-9.]/g, ""); if(this.value < 0) this.value = 0;')
              .form-group-wrapper
                label(for='warranty_months') Warranty Period
                input(type='text' class='form-control' id='warranty_months' name='warranty_months' 
                      value=(isEdit ? (asset && asset.warranty_months) || (formData && formData.warranty_months) : (formData && formData.warranty_months) || '') 
                      pattern='\d*' placeholder='Enter months'
                      oninput='this.value = this.value.replace(/[^0-9]/g, ""); if(this.value < 0) this.value = 0; updateWarrantyDisplay(this.value)')
          .form-section
            h6.form-section-title
              i.fas.fa-map-marker-alt.me-2
              | Location
            .form-row
              .form-group-wrapper
                label(for='branch') Branch
                input(type='text' 
                      class='form-control' 
                      id='branch' 
                      name='branch' 
                      value=(isEdit ? (asset && asset.branch) || (formData && formData.branch) : (formData && formData.branch) || '')
                      required
                      placeholder='Enter branch name')
              .form-group-wrapper
                label(for='location') Location
                input(type='text' class='form-control' id='location' name='location' 
                      value=(isEdit ? (asset && asset.location) || (formData && formData.location) : (formData && formData.location) || '')
                      placeholder='Enter location')
            .form-row
              .form-group-wrapper
                label(for='status')
                  span.required-field Status
                select.form-control(id='status' name='status' required)
                  option(value='') Select Status
                  option(value='available' selected=(isEdit ? (asset && asset.status === 'available') || (formData && formData.status === 'available') : (formData && formData.status === 'available'))) Available
                  option(value='maintenance' selected=(isEdit ? (asset && asset.status === 'maintenance') || (formData && formData.status === 'maintenance') : (formData && formData.status === 'maintenance'))) Maintenance
                  option(value='retired' selected=(isEdit ? (asset && asset.status === 'retired') || (formData && formData.status === 'retired') : (formData && formData.status === 'retired'))) Retired
                  option(value='scrapped' selected=(isEdit ? (asset && asset.status === 'scrapped') || (formData && formData.status === 'scrapped') : (formData && formData.status === 'scrapped'))) Scrapped
          .form-section
            h6.form-section-title
              i.fas.fa-sticky-note.me-2
              | Additional Information
            .form-row(style="grid-template-columns: 1fr;")
              .form-group-wrapper
                label(for='is_active') Active Status
                select.form-control(id='is_active' name='is_active')
                  option(value='true' selected=(isEdit ? (asset && asset.is_active === true) || (formData && formData.is_active === 'true') : (formData && formData.is_active === 'true'))) Active
                  option(value='false' selected=(isEdit ? (asset && asset.is_active === false) || (formData && formData.is_active === 'false') : (formData && formData.is_active === 'false'))) Inactive
            .form-row(style="grid-template-columns: 1fr;")
              .form-group-wrapper
                label(for='notes') Notes
                textarea.form-control(
                  id='notes' 
                  name='notes' 
                  placeholder='Enter any additional notes about this asset...'
                )= isEdit ? (asset && asset.notes) || (formData && formData.notes) : (formData && formData.notes) || ''
          .form-dialog-footer
            a.form-action-btn.form-action-btn-secondary(href='/assets')
              i.fas.fa-times
              | Cancel
            if isEdit
              a.form-action-btn.form-action-btn-secondary(href='/assets/#{asset.id}')
                i.fas.fa-eye
                | View
            button.form-action-btn.form-action-btn-primary(type='submit')
              i.fas.fa-save
              = isEdit ? 'Update Asset' : 'Create Asset'
    
    script.
      // Function to update warranty display
      function updateWarrantyDisplay(months) {
        const displayElement = document.querySelector('#warranty_months + .input-group-text');
        if (!displayElement) return;
        
        const monthsNum = parseInt(months) || 0;
        const years = Math.floor(monthsNum / 12);
        const remainingMonths = monthsNum % 12;
        
        let displayText = '';
        if (years > 0) {
          displayText += `${years} ${years === 1 ? 'year' : 'years'}`;
        }
        if (remainingMonths > 0) {
          if (years > 0) displayText += ' ';
          displayText += `${remainingMonths} ${remainingMonths === 1 ? 'month' : 'months'}`;
        }
        
        displayElement.textContent = displayText || '';
      }
      
      // Function to handle branch field
      function formatBranchDisplay() {
        const branchInput = document.getElementById('branch');
        if (branchInput) {
          branchInput.addEventListener('blur', function() {
            let value = this.value.trim();
            if (value && value.includes(',')) {
              // Take only first branch, trim spaces
              const firstBranch = value.split(',')[0].trim();
              this.value = firstBranch;
            }
          });
        }
      }

      function initializePurchaseDate() {
        const purchaseDateInput = document.getElementById('purchase_date');
        if (purchaseDateInput) {
          const today = new Date();
          purchaseDateInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d/]/g, '');
            // Auto-format as DD/MM/YYYY
            if (value.length === 2 && !value.includes('/')) {
              value += '/';
            } else if (value.length === 5 && value.split('/').length === 2) {
              value += '/';
            }
            
            e.target.value = value;
          });

          // Validate date on blur
          purchaseDateInput.addEventListener('blur', function() {
            const value = this.value.trim();
            
            if (!value) {
              this.setCustomValidity('');
              return;
            }
            
            // Simple DD/MM/YYYY format check
            const simpleRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = value.match(simpleRegex);
            
            if (!match) {
              this.setCustomValidity('Please enter date as DD/MM/YYYY (e.g., 15/01/2024)');
              return;
            }
            
            const [day, month, year] = match.slice(1);
            const date = new Date(year, month - 1, day);
            
            // Simple validation
            if (date.getDate() !== parseInt(day) || 
                date.getMonth() !== parseInt(month) - 1 || 
                date.getFullYear() !== parseInt(year)) {
              this.setCustomValidity('Invalid date. Please check day, month, and year.');
            } else if (date > today) {
              this.setCustomValidity('Purchase date cannot be in the future.');
            } else {
              this.setCustomValidity('');
            }
          });
        }
      }
      
      // Initialize on page load (works for both create and edit)
      document.addEventListener('DOMContentLoaded', function() {
        const warrantyInput = document.getElementById('warranty_months');
        if (warrantyInput && warrantyInput.value) {
          updateWarrantyDisplay(warrantyInput.value);
        }
        
        formatBranchDisplay();
        initializePurchaseDate();
      });
