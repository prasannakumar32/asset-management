extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;")
          if isEdit
            i.fas.fa-edit.me-2(style="color: #4e73df;")
            | Edit Asset
          else
            i.fas.fa-plus.me-2(style="color: #4e73df;")
            | Add New Asset
        
        // Messages
        if error && error.length > 0
          .alert.alert-danger.mb-3
            = error
        
        if success && success.length > 0
          .alert.alert-success.mb-3
            = success
        
        form(action=(isEdit ? `/assets/${asset.id}?_method=PUT` : '/assets'), method='POST', id='assetForm', novalidate)
          .form-section
            h6.form-section-title
              i.fas.fa-info-circle.me-2
              | Basic Information
            .form-row
              .form-group-wrapper
                label(for='name')
                  span.required-field Asset Name
                input(type='text' class='form-control' id='name' name='name' 
                      value=(isEdit ? (formData && formData.name) || (asset && asset.name) : (formData && formData.name) || '') 
                      required
                      placeholder='Enter asset name')
              .form-group-wrapper
                label(for='asset_tag') Asset Tag
                input(type='text' class='form-control' id='asset_tag' name='asset_tag' 
                      value=(isEdit ? (asset && asset.asset_tag) || (formData && formData.asset_tag) : (formData && formData.asset_tag) || '') 
                      readonly=isEdit
                      placeholder='Auto-generated on creation'
                      class=isEdit ? 'form-control' : ('form-control ' + (error && error.includes('Asset tag') ? 'is-invalid' : '')))
                if error && error.includes('Asset tag')
                  .invalid-feedback
                    i.fas.fa-exclamation-circle.me-1
                    = error
              .form-group-wrapper
                label(for='category_id')
                  span.required-field Category
                select.form-control(id='category_id' name='category_id' required)
                  option(value='') Select Category
                  if categories && categories.length > 0
                    each category in categories
                      option(value=category.id 
                             selected=(isEdit ? (formData && formData.category_id == category.id) || (asset && asset.category_id === category.id) : (formData && formData.category_id == category.id)))
                        = category.name
              .form-group-wrapper
                label(for='serial_number') Serial Number
                input(type='text' class='form-control' id='serial_number' name='serial_number' 
                      value=(isEdit ? (formData && formData.serial_number) || (asset && asset.serial_number) : (formData && formData.serial_number)) || ''
                      placeholder='Enter serial number'
                      class=('form-control ' + (error && error.includes('Serial number') ? 'is-invalid' : '')))
                if error && error.includes('Serial number')
                  .invalid-feedback
                    i.fas.fa-exclamation-circle.me-1
                    = error
              .form-group-wrapper
                label(for='model') Model
                input(type='text' class='form-control' id='model' name='model' 
                      value=(isEdit ? (formData && formData.model) || (asset && asset.model) : (formData && formData.model) || '')
                      placeholder='Enter model')
              .form-group-wrapper
                label(for='manufacturer') Manufacturer
                input(type='text' class='form-control' id='manufacturer' name='manufacturer' 
                      value=(isEdit ? (formData && formData.manufacturer) || (asset && asset.manufacturer) : (formData && formData.manufacturer) || '')
                      placeholder='Enter manufacturer')
          .form-section
            h6.form-section-title
              | Financial Information
            .form-row
              .form-group-wrapper
                label(for='purchase_date') Purchase Date
                input(type='date' class='form-control' id='purchase_date' name='purchase_date' 
                      value=(formData && formData.purchase_date ? formData.purchase_date : (isEdit && asset && asset.purchase_date ? new Date(asset.purchase_date).toISOString().split('T')[0] : ''))
                      placeholder='select purchase date '
                      title='Enter date in DD/MM/YYYY format')
                label(for='purchase_cost')
                  | Purchase Cost (₹)
                input(type='text' class='form-control' id='purchase_cost' name='purchase_cost' 
                      pattern='\d*\.?\d*' 
                      value=(isEdit ? (formData && formData.purchase_cost) || (asset && asset.purchase_cost) : (formData && formData.purchase_cost) || '')
                      placeholder='0.00'
                      oninput='this.value = this.value.replace(/[^0-9.]/g, ""); if(this.value < 0) this.value = 0;')
            .form-row
              .form-group-wrapper
                label(for='current_value')
                  | Current Value (₹)
                input(type='text' class='form-control' id='current_value' name='current_value' 
                      pattern='\d*\.?\d*' 
                      value=(isEdit ? (formData && formData.current_value) || (asset && asset.current_value) : (formData && formData.current_value) || '')
                      placeholder='0.00'
                      oninput='this.value = this.value.replace(/[^0-9.]/g, ""); if(this.value < 0) this.value = 0;')
              .form-group-wrapper
                label(for='warranty_months') Warranty Period
                input(type='text' class='form-control' id='warranty_months' name='warranty_months' 
                      value=(isEdit ? (formData && formData.warranty_months) || (asset && asset.warranty_months) : (formData && formData.warranty_months) || '') 
                      pattern='\d*' placeholder='Enter months'
                      oninput='this.value = this.value.replace(/[^0-9]/g, ""); if(this.value < 0) this.value = 0; updateWarrantyDisplay(this.value)')
          .form-section
            h6.form-section-title
              i.fas.fa-map-marker-alt.me-2
              | Location
            .form-row
              .form-group-wrapper
                label(for='branch') Branch
                select.form-control(id='branch' name='branch' required)
                  option(value='') Select Branch
                  if branches && branches.length > 0
                    each branch in branches
                      option(value=branch 
                             selected=(isEdit ? (formData && formData.branch === branch) || (asset && asset.branch === branch) : (formData && formData.branch === branch)))
                        = branch
              .form-group-wrapper
                label(for='location') Location
                input(type='text' class='form-control' id='location' name='location' 
                      value=(isEdit ? (formData && formData.location) || (asset && asset.location) : (formData && formData.location) || '')
                      placeholder='Enter location')
            .form-row
              .form-group-wrapper
                label(for='status')
                  span.required-field Status
                select.form-control(id='status' name='status' required)
                  option(value='') Select Status
                  option(value='available' selected=(isEdit ? (formData && formData.status === 'available') || (asset && asset.status === 'available') : (formData && formData.status === 'available'))) Available
                  option(value='assigned' selected=(isEdit ? (formData && formData.status === 'assigned') || (asset && asset.status === 'assigned') : (formData && formData.status === 'assigned'))) Assigned
                  option(value='maintenance' selected=(isEdit ? (formData && formData.status === 'maintenance') || (asset && asset.status === 'maintenance') : (formData && formData.status === 'maintenance'))) Maintenance
                  option(value='retired' selected=(isEdit ? (formData && formData.status === 'retired') || (asset && asset.status === 'retired') : (formData && formData.status === 'retired'))) Retired
                  option(value='scrapped' selected=(isEdit ? (formData && formData.status === 'scrapped') || (asset && asset.status === 'scrapped') : (formData && formData.status === 'scrapped'))) Scrapped
          .form-section
            h6.form-section-title
              i.fas.fa-sticky-note.me-2
              | Additional Information
            .form-row(style="grid-template-columns: 1fr;")
              .form-group-wrapper
                label(for='is_active') Active Status
                select.form-control(id='is_active' name='is_active')
                  option(value='true' selected=(isEdit ? (formData && formData.is_active === 'true') || (asset && asset.is_active === true) : (formData && formData.is_active === 'true'))) Active
                  option(value='false' selected=(isEdit ? (formData && formData.is_active === 'false') || (asset && asset.is_active === false) : (formData && formData.is_active === 'false'))) Inactive
            .form-row(style="grid-template-columns: 1fr;")
              .form-group-wrapper
                label(for='notes') Notes
                textarea.form-control(
                  id='notes' 
                  name='notes' 
                  placeholder='Enter any additional notes about this asset...'
                )= isEdit ? (formData && formData.notes) || (asset && asset.notes) : (formData && formData.notes) || ''
          .form-dialog-footer
            a.form-action-btn.form-action-btn-secondary(href='/assets')
              i.fas.fa-times
              | Cancel
            if isEdit
              a.form-action-btn.form-action-btn-secondary(href='/assets/#{asset.id}')
                i.fas.fa-eye
                | View
            button.form-action-btn.form-action-btn-primary(type='submit')
              i.fas.fa-save
              = isEdit ? 'Update Asset' : 'Create Asset'
    
    script.
      // Function to update warranty display
      function updateWarrantyDisplay(months) {
        const displayElement = document.querySelector('#warranty_months + .input-group-text');
        if (!displayElement) return;
        
        const monthsNum = parseInt(months) || 0;
        const years = Math.floor(monthsNum / 12);
        const remainingMonths = monthsNum % 12;
        
        let displayText = '';
        if (years > 0) {
          displayText += `${years} ${years === 1 ? 'year' : 'years'}`;
        }
        if (remainingMonths > 0) {
          if (years > 0) displayText += ' ';
          displayText += `${remainingMonths} ${remainingMonths === 1 ? 'month' : 'months'}`;
        } 
        displayElement.textContent = displayText || '';
      }
      
      // Initialize on page load (works for both create and edit)
      document.addEventListener('DOMContentLoaded', function() {
        const warrantyInput = document.getElementById('warranty_months');
        if (warrantyInput && warrantyInput.value) {
          updateWarrantyDisplay(warrantyInput.value);
        }
      });