extends ../navbar

block content
  .container-fluid.px-4.py-4
    .row.mb-4
      .col-12
        h1.text-center.mb-4
          i.fas.fa-hand-holding-box.me-2
          | Issue Asset to Employee
    
    .row.justify-content-center
      .col-lg-9.col-md-9
        .card.shadow
          .card-header
          .card-body
            form(action='/api/asset-assignment', method='POST', id='issueForm', novalidate, class='asset-form-container')
              .row.mb-3
                .col-12
                  .d-flex.justify-content-start
                    a(href='/assets' class='btn btn-outline-primary btn-sm')
                      i.fas.fa-arrow-left.me-2
                      | Back to Assets
              .row.mb-3
                .col-md-6
                  .form-group.mb-3
                    label(for='assetId' class='form-label required-field')
                      i.fas.fa-cube.me-2
                      | Asset *
                    select#assetId.form-select(name='asset_id', required)
                      option(value='') Select Asset
                    .invalid-feedback
                      | Please select an asset
                .col-md-6
                  .form-group.mb-3
                    label(for='employeeId' class='form-label required-field')
                      i.fas.fa-user.me-2
                      | Employee *
                    select#employeeId.form-select(name='employee_id', required)
                      option(value='') Select Employee
                    .invalid-feedback
                      | Please select an employee    
              .row.mb-3
                .col-md-6
                  .form-group.mb-3
                    label(for='assignedBy' class='form-label required-field')
                      i.fas.fa-user-tie.me-2
                      | Assigned By *
                    select#assignedBy.form-select(name='assigned_by', required)
                      option(value='') Select Manager/Staff
                      // Employees will be populated via JavaScript
                    .invalid-feedback
                      | Please select who is assigning this asset
                  
                .col-md-6
                  .form-group.mb-3
                    label(for='assignedDate' class='form-label')
                      i.fas.fa-calendar.me-2
                      | Assigned Date
                    input#assignedDate.form-control(name='assigned_date', type='date', value=new Date().toISOString().split('T')[0])
              
              .row.mt-4
                .col-6
                  a(href='/asset-assignment' class='btn btn-secondary')
                    i.fas.fa-times.me-2
                    | Cancel
                .col-6.text-end
                  button(type='submit' class='btn btn-primary')
                    i.fas.fa-paper-plane.me-2
                    | Issue Asset

block scripts
  script.
    document.addEventListener('DOMContentLoaded', function() {
      loadAvailableAssets();
      loadEmployees();
      loadAssigners();
    });

    async function loadAvailableAssets() {
      try {
        const response = await fetch('/api/assets');
        const result = await response.json();
        const assetSelect = document.getElementById('assetId');
        
        if (result.success && result.data) {
          // Display all active assets except those that are assigned
          const availableAssets = result.data.assets ? result.data.assets.filter(asset => asset.is_active && asset.status !== 'assigned') : [];
          
          if (availableAssets.length === 0) {
            return;
          }
          // Clear existing options
          assetSelect.innerHTML = '<option value="">Select Asset</option>';
          // Populate dropdown
          availableAssets.forEach(asset => {
            const option = document.createElement('option');
            option.value = asset.id;
            option.textContent = `${asset.name} (${asset.asset_tag})`;
            assetSelect.appendChild(option);
          });
          
        } else {
          console.error('Error loading assets:', result.error || 'Unknown error');
          console.error('Full result object:', result);
        }
      } catch (error) {
        console.error('Error loading assets:', error);
        console.error('Error details:', error.message);
      }
    }

    async function loadEmployees() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('employeeId');        
        if (result.success && result.data && result.data.employees) {
          // Clear existing options
          select.innerHTML = '<option value="">Select Employee</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.email})`;
              select.appendChild(option);
            }
          });
          
          if (select.children.length === 1) {
            console.warn('No active employees found');
          }
        } else {
          console.error('Error loading employees:', result.error || 'Invalid response format');
        }
      } catch (error) {
        console.error('Error loading employees:', error);
      }
    }

    // Simple form submission
    document.getElementById('issueForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
      
      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.fromEntries(formData.entries()))
        });
        
        const result = await response.json();
        
        if (result.success) {
          window.location.href = '/asset-assignment';
        } else {
          alert(result.message || 'Failed to assign asset');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    };

    async function loadAssigners() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('assignedBy');
        if (result.success && result.data && result.data.employees) {
          // Clear existing options
          select.innerHTML = '<option value="">Select Manager/Staff</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.position || 'Employee'})`;
              select.appendChild(option);
            }
          });
          
          if (select.children.length === 1) {
            console.warn('No active employees found for assigners');
          }
        } else {
          console.error('Error loading assigners:', result.error || 'Invalid response format');
        }
      } catch (error) {
        console.error('Error loading assigners:', error);
      }
    }
