extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;")
          i.fas.fa-hand-holding-box.me-2(style="color: #4e73df;")
          | Issue Asset to Employee
        form(action='/api/asset-assignment', method='POST', id='issueForm', novalidate)
          .form-section
            h6.form-section-title
              i.fas.fa-exchange-alt.me-2
              | Assignment Details
            .form-row
              .form-group-wrapper
                label(for='assetId')
                  span.required-field Asset
                select#assetId.form-control(name='asset_id', required)
                  option(value='') Select Asset
              .form-group-wrapper
                label(for='employeeId')
                  span.required-field Employee
                select#employeeId.form-control(name='employee_id', required)
                  option(value='') Select Employee
            .form-row
              .form-group-wrapper
                label(for='assignedBy')
                  span.required-field Assigned By
                select#assignedBy.form-control(name='assigned_by', required)
                  option(value='') Select Manager/Staff
              .form-group-wrapper
                label(for='assignedDate') Assigned Date
                input#assignedDate.form-control(name='assigned_date', type='date', value=new Date().toISOString().split('T')[0])
      .form-dialog-footer
        a.form-action-btn.form-action-btn-secondary(href='/assets')
          i.fas.fa-times
          | Cancel
        button.form-action-btn.form-action-btn-primary(type='submit')
          i.fas.fa-paper-plane
          | Issue Asset

block scripts
  script.
    document.addEventListener('DOMContentLoaded', function() {
      loadAvailableAssets();
      loadEmployees();
      loadAssigners();
    });

    async function loadAvailableAssets() {
      try {
        const response = await fetch('/api/assets?status=available&is_active=true');
        const result = await response.json();
        const assetSelect = document.getElementById('assetId');
        
        if (result.success && result.data) {
          const availableAssets = result.data.assets || [];
          
          if (availableAssets.length === 0) {
            return;
          }
          assetSelect.innerHTML = '<option value="">Select Asset</option>';
          availableAssets.forEach(asset => {
            const option = document.createElement('option');
            option.value = asset.id;
            option.textContent = `${asset.name} (${asset.asset_tag})`;
            assetSelect.appendChild(option);
          });
        } else {
          console.error('Error loading assets:', result.error || 'Unknown error');
          console.error('Full result object:', result);
        }
      } catch (error) {
        console.error('Error loading assets:', error);
        console.error('Error details:', error.message);
      }
    }

    async function loadEmployees() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('employeeId');        
        if (result.success && result.data && result.data.employees) {
          select.innerHTML = '<option value="">Select Employee</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.email})`;
              select.appendChild(option);
            }
          });
          if (select.children.length === 1) {
            console.warn('No active employees found');
          }
        } else {
          console.error('Error loading employees:', result.error || 'Invalid response format');
        }
      } catch (error) {
        console.error('Error loading employees:', error);
      }
    }

    document.getElementById('issueForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      
      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.fromEntries(formData.entries()))
        });
        
        const result = await response.json();
        
        if (result.success) {
          window.location.href = '/assets';
        } else {
          alert(result.message || 'Failed to assign asset');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    };

    async function loadAssigners() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('assignedBy');
        if (result.success && result.data && result.data.employees) {
          // Clear existing options
          select.innerHTML = '<option value="">Select Manager/Staff</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.position || 'Employee'})`;
              select.appendChild(option);
            }
          }); 
          
          if (select.children.length === 1) {
            console.warn('No active employees found for assigners');
          }
        } else {
          console.error('Error loading assigners:', result.error || 'Invalid response format');
        }
      } catch (error) {
        console.error('Error loading assigners:', error);
      }
    }
