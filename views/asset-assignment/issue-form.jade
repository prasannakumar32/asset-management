extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      #alertContainer
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;")
          i.fas.fa-hand-holding-box.me-2(style="color: #4e73df;")
          | Issue Asset to Employee
        form(action='/api/asset-assignment', method='POST', id='issueForm', novalidate)
          .form-section
            h6.form-section-title
              i.fas.fa-exchange-alt.me-2
              | Assignment Details
            .form-row
              .form-group-wrapper
                label(for='assetId')
                  span.required-field Asset
                select#assetId.form-control(name='asset_id', required)
                  option(value='') Select Asset
                .invalid-feedback(id='asset_id-error')
              .form-group-wrapper
                label(for='employeeId')
                  span.required-field Employee
                select#employeeId.form-control(name='employee_id', required)
                  option(value='') Select Employee
                .invalid-feedback(id='employee_id-error')
            .form-row
              .form-group-wrapper
                label(for='assignedBy')
                  span.required-field Assigned By
                select#assignedBy.form-control(name='assigned_by', required)
                  option(value='') Select Manager/Staff
                .invalid-feedback(id='assigned_by-error')
              .form-group-wrapper
                label(for='assignedDate') Assigned Date
                input#assignedDate.form-control(name='assigned_date', type='date', value=new Date().toISOString().split('T')[0], required)
                .invalid-feedback(id='assigned_date-error')
          .form-dialog-footer
            a.form-action-btn.form-action-btn-secondary(href='/assets')
              i.fas.fa-times
              | Cancel
            button.form-action-btn.form-action-btn-primary(type='submit')
              i.fas.fa-paper-plane
              | Issue Asset

block scripts
  script.
    document.addEventListener('DOMContentLoaded', function() {
      loadAvailableAssets();
      loadEmployees();
      loadAssigners();
      setupFormSubmission();
    });

    async function loadAvailableAssets() {
      try {
        const response = await fetch('/api/assets?status=available&is_active=true');
        const result = await response.json();
        const assetSelect = document.getElementById('assetId');
        
        if (result.success && result.data) {
          const availableAssets = result.data.assets || [];
          
          if (availableAssets.length === 0) {
            showAlert('No available assets found', 'warning');
            return;
          }
          assetSelect.innerHTML = '<option value="">Select Asset</option>';
          availableAssets.forEach(asset => {
            const option = document.createElement('option');
            option.value = asset.id;
            option.textContent = `${asset.name} (${asset.asset_tag})`;
            assetSelect.appendChild(option);
          });
        } else {
          console.error('Error loading assets:', result.error || 'Unknown error');
          showAlert('Error loading assets', 'danger');
        }
      } catch (error) {
        console.error('Error loading assets:', error);
        showAlert('Failed to load assets', 'danger');
      }
    }

    async function loadEmployees() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('employeeId');        
        if (result.success && result.data && result.data.employees) {
          select.innerHTML = '<option value="">Select Employee</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.email})`;
              select.appendChild(option);
            }
          });
          if (select.children.length === 1) {
            showAlert('No active employees found', 'warning');
          }
        } else {
          showAlert('Error loading employees', 'danger');
        }
      } catch (error) {
        console.error('Error loading employees:', error);
        showAlert('Failed to load employees', 'danger');
      }
    }

    async function loadAssigners() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('assignedBy');
        
        if (result.success && result.data && result.data.employees) {
          select.innerHTML = '<option value="">Select Manager/Staff</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.position || 'N/A'})`;
              select.appendChild(option);
            }
          });
        } else {
          showAlert('Error loading assigners', 'danger');
        }
      } catch (error) {
        console.error('Error loading assigners:', error);
        showAlert('Failed to load assigners', 'danger');
      }
    }
    
    function setupFormSubmission() {
      const form = document.getElementById('issueForm');
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Clear previous errors
        clearErrors();
        
        // Get form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
          const response = await fetch('/api/asset-assignment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            showAlert(result.message || 'Asset issued successfully', 'success');
            setTimeout(() => {
              $(location).attr('href', '/assets');
            }, 1500);
          } else {
            // Show error message
            showAlert(result.error || 'Error issuing asset', 'danger');
            
            // Show field-specific errors if available
            if (result.fieldErrors) {
              Object.keys(result.fieldErrors).forEach(field => {
                showFieldError(field, result.fieldErrors[field]);
              });
            }
          }
        } catch (error) {
          console.error('Error submitting form:', error);
          showAlert('Error submitting form', 'danger');
        }
      });
    }
    
    // Show alert message
    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-3`;
      alertDiv.role = 'alert';
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alertDiv);
    }
    
    // Show field-specific error
    function showFieldError(field, message) {
      const errorElement = document.getElementById(`${field}-error`);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }
    
    // Clear all errors
    function clearErrors() {
      document.querySelectorAll('.invalid-feedback').forEach(element => {
        element.textContent = '';
        element.style.display = 'none';
      });
    }
