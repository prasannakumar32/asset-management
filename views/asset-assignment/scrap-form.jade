extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;")
          i.fas.fa-trash-alt.me-2(style="color: #e74a3b;")
          | Scrap Asset
        form(action='/asset-assignment/scrap', method='POST', id='scrapForm')
          .form-section
            h6.form-section-title
              i.fas.fa-info-circle.me-2
              | Scrap Information
            .form-row
              .form-group-wrapper
                label(for='assetId')
                  span.required-field Asset
                select#assetId.form-control(name='asset_id', required)
                  option(value='') Select Asset
              .form-group-wrapper
                label(for='scrapDate')
                  span.required-field Scrap Date
                input#scrapDate.form-control(name='scrap_date', type='date', value=new Date().toISOString().split('T')[0], required)
            .form-row
              .form-group-wrapper
                label(for='method')
                  span.required-field Scrap Method
                select#method.form-control(name='method', required)
                  option(value='') Select Method
                  option(value='recycled') Recycled
                  option(value='disposed') Disposed
                  option(value='sold') Sold
                  option(value='donated') Donated
                  option(value='other') Other
              .form-group-wrapper
                label(for='employeeId')
                  span.required-field Scrapped By
                select#employeeId.form-control(name='employee_id', required)
          .form-section
            h6.form-section-title
              i.fas.fa-comment.me-2
              | Reason for Scrapping
            .form-row
              .form-group-wrapper
                label(for='reason')
                  span.required-field Reason
                textarea#reason.form-control(name='reason', rows='4', required, placeholder='Enter the reason for scrapping this asset...', style="resize: vertical; min-height: 120px;")
          .form-dialog-footer
            a.form-action-btn.form-action-btn-secondary(href='/assets')
              i.fas.fa-times
              | Cancel
            button.form-action-btn.form-action-btn-danger(type='submit')
              i.fas.fa-trash-alt
              | Confirm Scrap

block scripts
  script.
    document.addEventListener('DOMContentLoaded', function() {
      loadAvailableAssets();
      loadEmployees();
    });
    async function loadEmployees() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('employeeId');
        
        if (!select) {
          console.error('Employee select element not found');
          return;
        }
        if (result.success && result.data && Array.isArray(result.data.employees)) {
          // Clear existing options
          select.innerHTML = '<option value="">Select Employee</option>';
          const activeEmployees = result.data.employees.filter(employee => employee.status === 'active');
          if (activeEmployees.length === 0) {
            console.warn('No active employees found');
            return;
          }
          activeEmployees.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.id;
            option.textContent = `${employee.first_name} ${employee.last_name} (${employee.employee_id || employee.email})`;
            select.appendChild(option);
          });
          // If there's only one employee, select it by default
          if (activeEmployees.length === 1) {
            select.value = activeEmployees[0].id;
          }
        } else {
          console.error('Error loading employees:', result.error || 'Invalid response format');
          select.innerHTML = '<option value="">Error loading employees</option>';
        }
      } catch (error) {
        console.error('Error loading employees:', error);
        const select = document.getElementById('employeeId');
        if (select) {
          select.innerHTML = '<option value="">Error loading employees</option>';
        }
      }
    }

    async function loadAvailableAssets() {
      try {
        const response = await fetch('/api/assets');
        const result = await response.json();
        const assetSelect = document.getElementById('assetId');
        
        if (result.success && result.data) {
          // Display assets that can be scrapped (not already scrapped)
          const availableAssets = result.data.assets ? result.data.assets.filter(asset => asset.status !== 'scrapped') : [];
          // Clear existing options
          assetSelect.innerHTML = '<option value="">Select Asset</option>';
          
          if (availableAssets.length === 0) {
            assetSelect.innerHTML = '<option value="">No assets available for scrapping</option>';
            return;
          }
          // Populate dropdown
          availableAssets.forEach(asset => {
            const option = document.createElement('option');
            option.value = asset.id;
            option.textContent = `${asset.name} (${asset.asset_tag || 'No Tag'}) - ${asset.status}`;
            assetSelect.appendChild(option);
          });
        } else {
          console.error('Error loading assets:', result.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Error loading assets:', error);
      }
    }

    // Form submission
    document.getElementById('scrapForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
      
      try {
        const formData = new FormData(form);
        const response = await fetch('/asset-assignment/scrap', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.fromEntries(formData.entries()))
        });
        
        const result = await response.json();
        
        if (result.success) {
          window.location.href = '/assets';
        } else {
          alert(result.message || 'Failed to scrap asset');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    };
