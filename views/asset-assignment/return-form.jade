extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;")
          i.fas.fa-undo.me-2(style="color: #4e73df;")
          | Return Asset from Employee
        
        // Flash messages container
        #alertContainer
        
        form(action='/api/asset-assignment/return', method='POST', id='returnForm', novalidate)
          .form-section
            h6.form-section-title
              i.fas.fa-exchange-alt.me-2
              | Asset Details
            .form-row
              .form-group-wrapper
                label(for='employeeId')
                  span.required-field Employee
                select#employeeId.form-control(name='employee_id', required)
                  option(value='') Select Employee
                .invalid-feedback(id='employee_id-error')
              .form-group-wrapper
                label(for='assetId')
                  span.required-field Asset
                select#assetId.form-control(name='asset_id', required)
                  option(value='') Select Asset
                .invalid-feedback(id='asset_id-error')
            .form-row
              .form-group-wrapper
                label(for='returnDate')
                  span.required-field Return Date
                input#returnDate.form-control(name='return_date', type='date', value=new Date().toISOString().split('T')[0], required)
                .invalid-feedback(id='return_date-error')
              .form-group-wrapper
                label(for='returnCondition')
                  span.required-field Return Condition
                select#returnCondition.form-control(name='return_condition')
                  option(value='') Select Condition
                  option(value='good') Good
                  option(value='poor') Poor
                  option(value='damaged') Damaged
                  option(value='lost') Lost
                  option(value='stolen') Stolen
                .invalid-feedback(id='return_condition-error')
          .form-section
            h6.form-section-title
              i.fas.fa-sticky-note.me-2
              | Additional Information
            .form-row(style="grid-template-columns: 1fr;")
              .form-group-wrapper
                label(for='notes') Notes
                textarea#notes.form-control(name='notes', placeholder='Enter any additional notes...')
                .invalid-feedback(id='notes-error')
          .form-dialog-footer
            a.form-action-btn.form-action-btn-secondary(href='/assets')
              i.fas.fa-times
              | Cancel
            button.form-action-btn.form-action-btn-primary(type='submit')
              i.fas.fa-undo
              | Return Asset

block scripts
  script.
    document.addEventListener('DOMContentLoaded', function() {
      loadEmployees();
      setupFormSubmission();
    });

    async function loadEmployees() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const employeeSelect = document.getElementById('employeeId');
        
        if (result.success && result.data && result.data.employees) {
          employeeSelect.innerHTML = '<option value="">Select Employee</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.email})`;
              employeeSelect.appendChild(option);
            }
          });
          
          if (employeeSelect.children.length === 1) {
            showAlert('No active employees found', 'warning');
          }
        } else {
          showAlert('Error loading employees', 'danger');
        }
      } catch (error) {
        console.error('Error loading employees:', error);
        showAlert('Failed to load employees', 'danger');
      }
    }

    // Load assets when employee is selected
    document.getElementById('employeeId').addEventListener('change', async function() {
      const employeeId = this.value;
      const assetSelect = document.getElementById('assetId');
      
      if (!employeeId) {
        assetSelect.innerHTML = '<option value="">Select Asset</option>';
        return;
      }
      
      try {
        const response = await fetch(`/api/asset-assignment/employee/${employeeId}`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.assignments) {
          assetSelect.innerHTML = '<option value="">Select Asset</option>';
          
          result.data.assignments.forEach(assignment => {
            if (assignment.asset) {
              const option = document.createElement('option');
              option.value = assignment.asset.id;
              option.textContent = `${assignment.asset.name} (${assignment.asset.asset_tag})`;
              assetSelect.appendChild(option);
            }
          });
          
          if (assetSelect.children.length === 1) {
            showAlert('No assigned assets found for this employee', 'warning');
          }
        } else {
          showAlert('Error loading assigned assets', 'danger');
        }
      } catch (error) {
        console.error('Error loading assets:', error);
        showAlert('Failed to load assigned assets', 'danger');
      }
    });
    
    function setupFormSubmission() {
      const form = document.getElementById('returnForm');
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Clear previous errors
        clearErrors();
        
        // Get form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
          const response = await fetch('/api/asset-assignment/return', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            $(location).attr('href', '/assets');
          } else {
            // Show error message
            showAlert(result.error || 'Error returning asset', 'danger');
            
            // Show field-specific errors if available
            if (result.fieldErrors) {
              Object.keys(result.fieldErrors).forEach(field => {
                showFieldError(field, result.fieldErrors[field]);
              });
            }
          }
        } catch (error) {
          console.error('Error submitting form:', error);
          showAlert('Error submitting form', 'danger');
        }
      });
    }
    
    // Show alert message
    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-3`;
      alertDiv.role = 'alert';
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alertDiv);
    }
    
    // Show field-specific error
    function showFieldError(field, message) {
      const errorElement = document.getElementById(`${field}-error`);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
    }
    
    // Clear all errors
    function clearErrors() {
      document.querySelectorAll('.invalid-feedback').forEach(element => {
        element.textContent = '';
        element.style.display = 'none';
      });
    }