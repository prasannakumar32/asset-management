extends ../navbar

block content
  .form-dialog-container
    .form-dialog
      .form-dialog-header
      .form-dialog-content
        h1.text-center.mb-4(style="font-size: 1.8rem; font-weight: 600; color: #2e3338;")
          i.fas.fa-undo.me-2(style="color: #4e73df;")
          | Return Asset from Employee
        form(action='/api/asset-assignment/return', method='POST', id='returnForm', novalidate)
          .form-section
            h6.form-section-title
              i.fas.fa-exchange-alt.me-2
              | Asset Details
            .form-row
              .form-group-wrapper
                label(for='employeeId')
                  span.required-field Employee
                select#employeeId.form-control(name='employee_id', required)
                  option(value='') Select Employee
              .form-group-wrapper
                label(for='assetId')
                  span.required-field Asset
                select#assetId.form-control(name='asset_id', required)
                  option(value='') Select Asset
            .form-row
              .form-group-wrapper
                label(for='returnDate')
                  span.required-field Return Date
                input#returnDate.form-control(name='return_date', type='date', value=new Date().toISOString().split('T')[0], required)
              .form-group-wrapper
                label(for='returnCondition')
                  span.required-field Return Condition
                select#returnCondition.form-control(name='return_condition')
                  option(value='') Select Condition
                  option(value='excellent') Excellent
                  option(value='good') Good
                  option(value='fair') Fair
                  option(value='poor') Poor
                  option(value='damaged') Damaged
          .form-section
            h6.form-section-title
              i.fas.fa-sticky-note.me-2
              | Additional Information
            .form-row(style="grid-template-columns: 1fr;")
              .form-group-wrapper
                label(for='notes') Notes
                textarea#notes.form-control(name='notes', placeholder='Enter any additional notes...')
      .form-dialog-footer
        a.form-action-btn.form-action-btn-secondary(href='/assets')
          i.fas.fa-times
          | Cancel
        button.form-action-btn.form-action-btn-primary(type='submit')
          i.fas.fa-undo
          | Return Asset

block scripts
  script.
    document.addEventListener('DOMContentLoaded', function() {
      loadEmployees();
      setupEmployeeChangeHandler();
    });

    async function loadEmployees() {
      try {
        const response = await fetch('/api/employee');
        const result = await response.json();
        const select = document.getElementById('employeeId');
        
        if (result.success && result.data && result.data.employees) {
          // Clear existing options
          select.innerHTML = '<option value="">Select Employee</option>';
          
          result.data.employees.forEach(employee => {
            if (employee.status === 'active') {
              const option = document.createElement('option');
              option.value = employee.id;
              option.textContent = `${employee.first_name} ${employee.last_name} (${employee.email})`;
              select.appendChild(option);
            }
          });
          
          if (select.children.length === 1) {
            console.warn('No active employees found');
          }
        } else {
          console.error('Error loading employees:', result.error || 'Invalid response format');
        }
      } catch (error) {
        console.error('Error loading employees:', error);
      }
    }

    function setupEmployeeChangeHandler() {
      const employeeSelect = document.getElementById('employeeId');
      employeeSelect.addEventListener('change', loadEmployeeAssets);
    }

    async function loadEmployeeAssets() {
      const employeeId = document.getElementById('employeeId').value;
      const assetSelect = document.getElementById('assetId');
      
      if (!employeeId) {
        assetSelect.innerHTML = '<option value="">Select Employee First</option>';
        return;
      }

      try {
        const response = await fetch(`/api/asset-assignment/employee/${employeeId}`);
        const result = await response.json();
        
        // Clear existing options
        assetSelect.innerHTML = '<option value="">Select Asset</option>';
        
        if (result.success && result.data && result.data.assignments) {
          const assignments = result.data.assignments;
          
          if (assignments.length === 0) {
            assetSelect.innerHTML = '<option value="">No assigned assets found</option>';
            return;
          }
          
          assignments.forEach(assignment => {
            const option = document.createElement('option');
            option.value = assignment.asset.id;
            option.textContent = `${assignment.asset.name} (${assignment.asset.asset_tag})`;
            assetSelect.appendChild(option);
          });
        } else {
          assetSelect.innerHTML = '<option value="">No assigned assets found</option>';
        }
      } catch (error) {
        console.error('Error loading employee assets:', error);
        assetSelect.innerHTML = '<option value="">Error loading assets</option>';
      }
    }

    // Simple form submission
    document.getElementById('returnForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
      
      try {
        const formData = new FormData(form);
        const response = await fetch('/api/asset-assignment/return', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.fromEntries(formData.entries()))
        });
        
        const result = await response.json();
        
        if (result.success) {
          window.location.href = '/assets';
        } else {
          alert(result.message || 'Failed to process return');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    }