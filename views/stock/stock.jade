extends ../navbar

block content
  .container-fluid.px-4.py-4
    .row.mb-4
      .col-12
        h1.mb-4 Stock View
    
    .row.mb-4
      .col-12
        .dashboard-horizontal
          .card(data-metric="totalAssets")
            .card-icon
              i.fa.fa-cubes.fa-2x
            .card-content
              h3 Total Assets
              .number.loading 0
              .description Active assets in system
          .card(data-metric="available")
            .card-icon
              i.fa.fa-check-circle.fa-2x
            .card-content
              h3 Available
              .number.loading 0
              .description Available for assignment
          .card(data-metric="assigned")
            .card-icon
              i.fa.fa-user.fa-2x
            .card-content
              h3 Assigned
              .number.loading 0
              .description Currently assigned
          .card(data-metric="branches")
            .card-icon
              i.fa.fa-code-branch.fa-2x
            .card-content
              h3 Branches
              .number.loading 0
              .description Active branches
    
    #stockDataContainer
    
    script.
      function loadStockData(retryCount = 0, isManualRefresh = false) {
        
        // Show loading state
        const container = document.getElementById('stockDataContainer');
        if (isManualRefresh || retryCount === 0) {
          container.innerHTML = `
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-muted">${isManualRefresh ? 'Refreshing stock data...' : 'Loading stock data...'}</p>
            </div>
          `;
        }
        
        fetch('/api/stock')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              updateDashboard(data.data);
              renderStockData(data.data);
            } else {
              console.error('API returned error:', data);
              showError('Unable to load stock data: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Stock data error:', error);
            if (retryCount < 2) {
              setTimeout(() => loadStockData(retryCount + 1, isManualRefresh), 1000);
            } else {
              showError('Failed to connect to server: ' + error.message);
            }
          });
      }
      
      document.addEventListener('DOMContentLoaded', () => loadStockData());
      
      function updateDashboard(data) {
        // Update dashboard cards using same pattern as dashboard
        const totalAssetsEl = document.querySelector('[data-metric="totalAssets"] .number');
        const availableEl = document.querySelector('[data-metric="available"] .number');
        const assignedEl = document.querySelector('[data-metric="assigned"] .number');
        const branchesEl = document.querySelector('[data-metric="branches"] .number');
        
        if (totalAssetsEl) {
          totalAssetsEl.textContent = data.totalAssets || 0;
          totalAssetsEl.classList.remove('loading');
        }
        if (availableEl) {
          availableEl.textContent = data.availableCount?.available || 0;
          availableEl.classList.remove('loading');
        }
        if (assignedEl) {
          assignedEl.textContent = data.availableCount?.assigned || 0;
          assignedEl.classList.remove('loading');
        }
        if (branchesEl) {
          branchesEl.textContent = Object.keys(data.assetsByBranch || {}).length;
          branchesEl.classList.remove('loading');
        }
      }
      
      function renderStockData(data) {
        const container = document.getElementById('stockDataContainer');
        const assetsByBranch = data.assetsByBranch || {};
        
        if (Object.keys(assetsByBranch).length === 0) {
          container.innerHTML = `
            <div class="text-center py-5">
              <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No assets found</h5>
              <p class="text-muted">There are currently no assets in the system.</p>
            </div>
          `;
          return;
        }
        
        let html = '';
        for (const [branch, branchData] of Object.entries(assetsByBranch)) {
          html += createBranchSection(branch, branchData);
        }
        container.innerHTML = html;
      }
      
      function createBranchSection(branch, branchData) {
        const badges = getStatusBadges(branchData);
        const assetRows = branchData.assets.map(asset => `
          <tr>
            <td><small class="text-muted">${asset.asset_tag || 'N/A'}</small></td>
            <td><a href="/assets/${asset.id}" class="text-decoration-none">${asset.name}</a></td>
            <td><span class="badge bg-light text-dark">${asset.category?.name || 'Uncategorized'}</span></td>
            <td><span class="badge ${getStatusClass(asset.status)}">${asset.status}</span></td>
            <td class="fw-semibold">₹${parseFloat(asset.current_value || asset.purchase_cost || 0).toFixed(2)}</td>
          </tr>
        `).join('');
        
        const totalValue = branchData.totalValue ? 
          `<tr class="table-active">
            <td colspan="4" class="text-end fw-bold">Total Value:</td>
            <td class="fw-bold text-success">₹${parseFloat(branchData.totalValue).toFixed(2)}</td>
          </tr>` : '';
        
        return `
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-semibold">
                  <i class="fas fa-building me-2 text-primary"></i>${branch}
                </h5>
                <div class="badge-container">${badges}</div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Asset Tag</th>
                      <th scope="col">Name</th>
                      <th scope="col">Category</th>
                      <th scope="col">Status</th>
                      <th scope="col">Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${assetRows}
                    ${totalValue}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }
      
      function getStatusBadges(branchData) {
        const badges = [];
        if (branchData.available > 0) badges.push(`<span class="badge bg-success me-1">${branchData.available} available</span>`);
        if (branchData.assigned > 0) badges.push(`<span class="badge bg-info me-1">${branchData.assigned} assigned</span>`);
        if (branchData.maintenance > 0) badges.push(`<span class="badge bg-secondary me-1">${branchData.maintenance} maintenance</span>`);
        if (branchData.scrapped > 0) badges.push(`<span class="badge bg-danger me-1">${branchData.scrapped} scrapped</span>`);
        if (branchData.retired > 0) badges.push(`<span class="badge bg-secondary me-1">${branchData.retired} retired</span>`);
        return badges.join('');
      }
      
      function getStatusClass(status) {
        const classes = {
          'available': 'bg-success',
          'assigned': 'bg-info',
          'maintenance': 'bg-secondary',
          'retired': 'bg-secondary',
          'scrapped': 'bg-danger'
        };
        return classes[status] || 'bg-secondary';
      }
      
      function showError(message) {
        document.getElementById('stockDataContainer').innerHTML = `
          <div class="alert alert-warning text-center" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
          </div>
        `;
      }